-- Enable UUIDs
create extension if not exists "uuid-ossp";

-- Professionals
create table if not exists professionals (
  id uuid primary key default uuid_generate_v4(),
  full_name text not null,
  title text not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- Projects
create table if not exists projects (
  id uuid primary key default uuid_generate_v4(),
  name text not null,
  start_date date not null,
  end_date date not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint project_dates_valid check (end_date >= start_date)
);

-- Project roles
create table if not exists project_roles (
  id uuid primary key default uuid_generate_v4(),
  project_id uuid not null references projects(id) on delete cascade,
  role_name text not null,
  start_date date not null,
  end_date date not null,
  required_percent int not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint role_dates_valid check (end_date >= start_date),
  constraint role_required_percent_valid check (required_percent between 0 and 100)
);

-- Allocations: both ACTUAL (sold) and PROPOSED live here
do $$ begin
  if not exists (select 1 from pg_type where typname = 'allocation_kind') then
    create type allocation_kind as enum ('actual','proposed');
  end if;
end $$;

create table if not exists allocations (
  id uuid primary key default uuid_generate_v4(),
  professional_id uuid not null references professionals(id) on delete cascade,
  project_id uuid not null references projects(id) on delete cascade,
  project_role_id uuid references project_roles(id) on delete set null,
  kind allocation_kind not null,
  percent int not null,
  start_date date not null,
  end_date date not null,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  constraint allocation_percent_valid check (percent between 0 and 100),
  constraint allocation_dates_valid check (end_date >= start_date)
);

-- Helpful indexes
create index if not exists idx_roles_project on project_roles(project_id);
create index if not exists idx_alloc_professional on allocations(professional_id);
create index if not exists idx_alloc_project on allocations(project_id);
create index if not exists idx_alloc_kind on allocations(kind);

-- Updated_at trigger helper
create or replace function set_updated_at()
returns trigger as $$
begin
  new.updated_at = now();
  return new;
end;
$$ language plpgsql;

drop trigger if exists trg_prof_updated on professionals;
create trigger trg_prof_updated before update on professionals
for each row execute procedure set_updated_at();

drop trigger if exists trg_proj_updated on projects;
create trigger trg_proj_updated before update on projects
for each row execute procedure set_updated_at();

drop trigger if exists trg_role_updated on project_roles;
create trigger trg_role_updated before update on project_roles
for each row execute procedure set_updated_at();

drop trigger if exists trg_alloc_updated on allocations;
create trigger trg_alloc_updated before update on allocations
for each row execute procedure set_updated_at();

-- RLS (optional): if you're using anon key in browser, you likely want policies.
-- For a quick prototype, you can disable RLS. For real apps, enable and add auth-based policies.

alter table professionals enable row level security;
alter table projects enable row level security;
alter table project_roles enable row level security;
alter table allocations enable row level security;

-- Quick prototype policy: allow all (NOT recommended for production)
drop policy if exists "public_all_professionals" on professionals;
create policy "public_all_professionals" on professionals for all using (true) with check (true);

drop policy if exists "public_all_projects" on projects;
create policy "public_all_projects" on projects for all using (true) with check (true);

drop policy if exists "public_all_roles" on project_roles;
create policy "public_all_roles" on project_roles for all using (true) with check (true);

drop policy if exists "public_all_allocations" on allocations;
create policy "public_all_allocations" on allocations for all using (true) with check (true);
